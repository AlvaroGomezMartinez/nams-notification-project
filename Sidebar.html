<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      label { display: block; margin-top: 12px; }
      input, select, button { margin-top: 4px; width: 100%; padding: 6px; }
  #notification { color: red; font-weight: bold; margin-top: 12px; transition: color 0.2s; }
        /* Spinner styles */
        .spinner {
          display: none;
          margin: 16px auto;
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
  </head>
  <body>
    <h2>Restroom Log</h2>
    <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
      <button type="button" id="helpButton" style="width:auto; padding:6px 12px;">Help</button>
    </div>
    <form id="restroomForm">
      <label>Student ID
        <input type="text" id="studentId" required>
      </label>
      <label>G or B
        <select id="gb" required>
          <option value="">Select...</option>
          <option value="G">G</option>
          <option value="B">B</option>
        </select>
      </label>
      <label>Period
        <select id="period" required>
          <option value="1">1st</option>
          <option value="2">2nd</option>
          <option value="3">3rd</option>
          <option value="4">4th</option>
          <option value="5">5th</option>
          <option value="6">6th</option>
          <option value="7">7th</option>
          <option value="8">8th</option>
        </select>
      </label>
      <label>Notes
        <textarea id="notes" rows="3" style="width:100%; padding:6px; margin-top:4px;" placeholder="Optional notes..."></textarea>
      </label>
  <button type="button" onclick="logUsage('Out')">Out</button>
  <button type="button" onclick="logUsage('Back')">Back</button>
    </form>
    <div id="notification"></div>
    <div id="spinner" class="spinner"></div>
    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); max-width:320px; margin:auto; text-align:center;">
        <h3 style="margin-top:0;">Confirmation</h3>
        <div id="modalMessage" style="margin-bottom:18px;"></div>
        <button id="modalYes" style="background:#388e3c; color:#fff; border:none; padding:8px 18px; border-radius:4px; margin-right:10px;">Yes</button>
        <button id="modalNo" style="background:#b71c1c; color:#fff; border:none; padding:8px 18px; border-radius:4px;">No</button>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1100; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:20px 18px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.25); max-width:520px; width:92%; max-height:80vh; overflow:auto; margin:auto;">
        <h2 style="margin-top:0;">Restroom Log - Help</h2>
        <div style="font-size:13px; line-height:1.4; color:#222;">
          <h3 style="margin-bottom:6px;">Using the Sidebar</h3>
          <ol>
            <li>Enter the Student ID exactly as shown on the daily roster (column E on the day sheet). If the ID is not found you will receive an error.</li>
            <li>Select the student's Gender (G or B) and the current class Period.</li>
            <li>Optional: add any Notes that explain the reason or context.</li>
            <li>Click <strong>Out</strong> to log the student leaving. Click <strong>Back</strong> to mark them as returned.</li>
            <li>If a student has already used the restroom twice in the AM or PM, the sidebar will warn you and ask for confirmation before logging a third Out. Use the confirmation dialog to force the entry if appropriate.</li>
          </ol>

          <h3 style="margin-bottom:6px;">Archiving Data (Move AM/PM logs to Database)</h3>
          <ol>
            <li>From the Google Sheets menu choose <em>Restroom Log &gt; Move current AM/PM logs to Database</em>. This action will:</li>
            <ul>
              <li>Copy all non-empty rows from the AM and PM sheets (excluding their header rows) into the <code>Database</code> sheet.</li>
              <li>If the <code>Database</code> sheet does not exist it will be created with headers.</li>
              <li>After copying, the AM and PM sheets will be cleared (rows below the header will be removed).</li>
            </ul>
            <li>Make sure you only archive when you are ready to permanently move that day's AM/PM log rows to the database. Consider making a copy of the spreadsheet before major operations if you need a backup.</li>
          </ol>

          <h3 style="margin-bottom:6px;">Tips & Troubleshooting</h3>
          <ul>
            <li>If you see "Student ID not found", verify the ID in the day sheet (column E, starting row 3) or check that the correct day sheet is visible and not hidden.</li>
            <li>Use the <strong>Log Students</strong> menu item to reopen the sidebar if it is closed.</li>
            <li>If the script reports permissions errors, ensure you have authorized the Apps Script project to access the sheet and your email (first-time authorization required).</li>
          </ul>
        </div>
        <div style="text-align:right; margin-top:12px;">
          <button id="closeHelp" style="padding:8px 12px; border-radius:4px; border:none; background:#1976d2; color:#fff;">Close</button>
        </div>
      </div>
    </div>
    <script>
  /**
   * Show a custom confirmation modal.
   * @param {string} message - Message to display inside the modal.
   * @param {Function} [onYes] - Callback executed when the user confirms.
   * @param {Function} [onNo] - Callback executed when the user cancels.
   * @return {void}
   */
  function showCustomModal(message, onYes, onNo) {
        var modal = document.getElementById('customModal');
        var msg = document.getElementById('modalMessage');
        msg.textContent = message;
        modal.style.display = 'flex';
        document.getElementById('modalYes').onclick = function() {
          modal.style.display = 'none';
          if (onYes) onYes();
        };
        document.getElementById('modalNo').onclick = function() {
          modal.style.display = 'none';
          if (onNo) onNo();
        };
      }

  /**
   * Submit a restroom usage event to the server-side Apps Script function `logRestroomUsage`.
   * Reads values from the form (`studentId`, `gb`, `period`) and updates UI elements
   * such as the spinner and notification area based on the server response.
   *
   * @param {'Out'|'Back'} action - The action being logged.
   * @param {boolean} [forceLog] - When true, bypasses client-side confirmation checks.
   * @return {void}
   */
  function logUsage(action, forceLog) {
        var studentId = document.getElementById('studentId').value;
        var gb = document.getElementById('gb').value;
        var period = document.getElementById('period').value;
        var note = document.getElementById('notification');
        var spinner = document.getElementById('spinner');
        if (!studentId || !period || !gb) return;
        spinner.style.display = 'block';
        var notes = document.getElementById('notes').value;
        console.log('Calling logRestroomUsage with', { studentId: studentId, period: period, gb: gb, notes: notes, action: action, forceLog: !!forceLog });
        google.script.run
          .withSuccessHandler(function(result) {
          console.log('logRestroomUsage result', result);
          var shouldClear = false;
          if (result && result.error) {
            note.textContent = result.error;
            note.style.color = 'red';
          } else if (action === 'Out') {
            // If the server requires a confirmation (this would be the 3rd Out), show the modal and do not append yet
            if (result && result.confirmationNeeded && !forceLog) {
              note.textContent = '⛔️ Alert: ' + (result.studentName ? result.studentName : 'This student') + ' has already used the restroom twice during this half of the day.';
              note.style.color = 'red';
              spinner.style.display = 'none';
              showCustomModal('This student has already used the restroom twice during this half of the day! Would you like to log this anyway?',
                function() { logUsage(action, true); },
                function() {
                  // Reset the whole form, clear notification and spinner when user cancels
                  try { document.getElementById('restroomForm').reset(); } catch (e) {}
                  note.textContent = '';
                  spinner.style.display = 'none';
                  // Return focus to the Student ID field for quick retry
                  try { document.getElementById('studentId').focus(); } catch (e) {}
                });
              return;
            }
            // If server appended the row (either normally or via force), show success
            if (result && result.appended) {
              var newCount = (typeof result.countAfter === 'number' ? result.countAfter : (typeof result.countBefore === 'number' ? result.countBefore + 1 : 1));
              note.textContent = '✅ ' + result.studentName + ' was added to the ' + result.logSheetName + ' log.';
              note.style.color = 'green';
              // If the new total is 3 or more, show an additional warning
              if (newCount >= 3) {
                note.textContent += '\n⚠️ Warning: ' + result.studentName + ' has now logged out ' + newCount + ' times this ' + result.logSheetName + ' today.';
                note.style.color = 'orange';
              }
              shouldClear = true;
            } else {
              // Not appended (e.g., limit reached and not forced) — show informative message
              if (result && result.studentName && !result.appended) {
                // If countBefore is already >=3, surface a stronger warning
                if (result.countBefore >= 3) {
                  note.textContent = '⚠️ Alert: ' + result.studentName + ' has already logged out ' + result.countBefore + ' times this ' + result.logSheetName + '.';
                  note.style.color = 'red';
                } else {
                  note.textContent = 'Notice: ' + result.studentName + ' was not logged (limit reached). Use the modal to force logging.';
                  note.style.color = 'orange';
                }
              }
            }
          } else if (action === 'Back' && result && result.studentName) {
            note.textContent = '✅ ' + result.studentName + ' was marked as Back.';
            note.style.color = 'green';
            shouldClear = true;
          } else {
            note.textContent = '';
            note.style.color = 'red';
          }
          spinner.style.display = 'none';
          if (shouldClear) {
            setTimeout(function() {
              note.textContent = '';
              document.getElementById('restroomForm').reset();
            }, 3000);
          }
        })
        .withFailureHandler(function(err) {
          console.error('logRestroomUsage failed', err);
          spinner.style.display = 'none';
          note.textContent = 'Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          note.style.color = 'red';
        })
      .logRestroomUsage({studentId: studentId, period: period, gb: gb, notes: notes, action: action, forceLog: !!forceLog});
      }
    
      // Help modal handlers
      (function() {
        function $(id) { return document.getElementById(id); }
        var helpButton = $('helpButton');
        var helpModal = $('helpModal');
        var closeHelp = $('closeHelp');
        if (helpButton && helpModal) {
          helpButton.addEventListener('click', function() {
            helpModal.style.display = 'flex';
            // scroll top of modal content
            try { helpModal.querySelector('div').scrollTop = 0; } catch (e) {}
          });
        }
        if (closeHelp && helpModal) {
          closeHelp.addEventListener('click', function() { helpModal.style.display = 'none'; });
        }
        // Clicking outside modal content closes it
        if (helpModal) {
          helpModal.addEventListener('click', function(e) {
            if (e.target === helpModal) helpModal.style.display = 'none';
          });
        }
      })();
    </script>
  </body>
</html>
